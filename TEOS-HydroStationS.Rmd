---
title: "TEOS Hydrostation Data Lab"
author: "Juanita Carballeira"
date: "2023-03-07"
output: html_document
  #prettydoc::html_pretty:
    #theme: architect
   #highlight: github
---

## Load required libraries
```{r message = FALSE, warning = FALSE}
#install.packages("gws")
library(prettydoc)
library(tidyverse)
library(gsw)
library(readr)
```

## Now we need to import our data
```{r message = FALSE, warning = FALSE}
hydrostation_bottle <- read_delim("hydrostation_bottle.txt", 
    delim = "\t", escape_double = FALSE, 
    col_names = FALSE, trim_ws = TRUE, skip = 31)

hydrostation_bottle_names <- read_csv("hydrostation_bottle.txt", 
    skip = 30)

colnames(hydrostation_bottle) = colnames(hydrostation_bottle_names)
#view(hydrostation_bottle)
```

## Hydrostation S Discrete Bottle Data for years 1955 through December 2020.

### Variable Names and Units

- yyyymmdd = Year Month Day   
- decy   = Decimal Year     
- time   = Time (hhmm)      
- latN   = Latitude (Deg N) 
- lonW   = Longitude (Deg W)
- Depth  = Depth (m)                  
-Temp   = Temperature ITS-90 (C) 
- Pres   = CTD Pressure (dbar)   
- CTD_S  = CTD Salinity (PSS-78)      
- Sal1   = Salinity-1 (PSS-78)        
- Sig-th = Sigma-Theta (kg/m^3)       
- O2(1)  = Oxygen-1 (umol/kg)          
- OxFixT = Oxygen Fix Temp (C)        
- Anom1  = Oxy Anomaly-1 (umol/kg)    
Quality flags
- -999  = No data
- 0 = Less than detection limit
```{r}
# lets first plot the data
hydrostation_bottle %>% 
  filter(`Sig-th`!= -999) %>% # filter out -999 no data flag
  ggplot()+geom_point(aes(x=decy, y = `Sig-th`)) # hard to interpret even w no -999s

hydrostation_bottle %>% 
  filter(`Sig-th`!= -999 & Depth <20) %>% # filter out -999 no data flag and by upper 20m
  ggplot()+geom_line(aes(x=decy, y = `Sig-th`)) # line shows seasonality 
# clear seasonal signal for sigma-theta, lets see how this compares to temp
hydrostation_bottle %>% 
  filter(`Sig-th`!= -999 & Depth <20) %>% # filter out -999 no data flag and by upper 20m
  ggplot()+geom_point(aes(x=Temp, y = `Sig-th`))

```

```{r setup, include=FALSE}
?gsw
?gsw_sigma0

?gsw_SA_from_SP
#practical salinity
#sea pressure dbar
#longitude
#latitude


##plot pressure data-missing before 1980s
hydrostation_bottle%>%
  ggplot()+geom_point(aes(x=decy,y=Pres))

#we have depth for time series
  
hydrostation_bottle %>%
  ggplot()+
  geom_point(aes(x=decy,y=Depth))

##Add pressure column
hydrostation_bottle=
  hydrostation_bottle %>%
  mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN))

hydrostation_bottle %>% 
  ggplot()+
  geom_point(aes(x=Pres,y=Pres_gsw))
#Strong 1:1 agreement
  
hydrostation_bottle %>% 
  ggplot()+geom_point(aes(x=decy,y=latN))

hydrostation_bottle=
  hydrostation_bottle%>%
  mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN))%>%
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN))

view(hydrostation_bottle)

#check it!
#hydrostation_bottle%>%
  #ggplot()+
 # geom_point(aes(x=decy,y=S_abs_gsw))
  
#how else can you check data
hydrostation_bottle%>%
  filter(Sal1!=-999)%>%
  ggplot()+
  geom_point(aes(x=Sal1,y=S_abs_gsw))

View(hydrostation_bottle)
#we need conservative temperature
#we need absolute salinity in situ-temp (ITS-90)

###calculate conserv temp
HydroS=
  hydrostation_bottle%>%
  filter(Sal1!=-999) %>%
  mutate(Pres_gsw=gsw_p_from_z(Depth*-1,latN))%>%
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN))%>%
  mutate(T_cons_gsw=gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw))
  
HydroS %>% 
  filter(Temp!= -999) %>% 
  ggplot()+
  geom_point(aes(x=Temp, y =T_cons_gsw))

#Add line to calculate conservative temp
HydroS=
  hydrostation_bottle %>% 
  filter(Sal1!=-999) %>%
  mutate(Pres_gsw = gsw_p_from_z(Depth*-1,latN,)) %>% 
  mutate(S_abs_gsw=gsw_SA_from_SP(Sal1,Pres_gsw,360-lonW,latN)) %>% 
  mutate(T_cons_gsw = gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw)) %>% 
  mutate(Sig_th_gsw = gsw_sigma0(S_abs_gsw,T_cons_gsw))


HydroS%>%
  filter(`Sig-th`!=-999)%>%
  ggplot()+
  geom_point(aes(x=`Sig-th`,y=Sig_th_gsw))

HydroS %>% 
  filter(Sig_th_gsw<0)  
  View(HydroS)
```


```{r}

HydroS_corrected_a =
  HydroS %>% 
  filter(Sig_th_gsw<0) %>%
  mutate(S_abs_gsw=gsw_SA_from_SP(CTD_S,Pres_gsw,360-lonW,latN)) %>% 
  mutate(T_cons_gsw = gsw_CT_from_t(S_abs_gsw,Temp,Pres_gsw)) %>% 
  mutate(Sig_th_gsw = gsw_sigma0(S_abs_gsw,T_cons_gsw))

View(HydroS_corrected_a)

HydroS_corrected_b =
  HydroS %>% 
  filter(Sig_th_gsw>0)

HydroS_corrected = rbind(HydroS_corrected_a, HydroS_corrected_b) 

View(HydroS_corrected)

HydroS_corrected %>% 
  filter(`Sig-th`!= -999) %>% 
  ggplot()+
  geom_point(aes(x=`Sig-th`, y=Sig_th_gsw))


HydroS_corrected %>% 
  ggplot()+
  geom_point(aes(x=Sig_th_gsw, y = Depth))+
  scale_y_reverse()+
  scale_x_continuous(position ="top")+
  xlab(expression(paste(sigma[theta]," (kg m"^"-3",")")))+
  ylab("Depth(m)")

View(HydroS_corrected)
```


```{r}
library(plotly)
HydroS_shallow = HydroS_corrected %>% 
  filter(Depth<30)
sig_theta_tm = lm(Sig_th_gsw~decy,data =  HydroS_shallow) # y (Sig) is a function of x(decy), lm(y~x,data = data )
summary(sig_theta_tm)
plot = HydroS_shallow %>% 
  ggplot()+
  geom_point(aes(x=decy, y=Sig_th_gsw))+
  geom_line(aes(x=decy, y=Sig_th_gsw))+
  geom_smooth(aes(x=decy, y=Sig_th_gsw),method = "lm")+
  theme_classic()
ggplotly(plot)


## Homework
#something like select or combination of filters
#how ro replace Hydry a and b in a same argument.

        
            
```
# Lab Assigment 

1. pick question
2. Produce a plot and statistical summary using lm()
3. Describe results, summary and answer question
4. Compile into lab report 

Potential
1. How does temp, salinity, sigma-theta covary
2. Relationship between sigma-theta and oxygen
3. Relationship with any of parameters witth depth?
time within a range over time?
4. Seasonal difference between parameters. 

```{r}
Homework = HydroS_corrected %>% 
  filter(Temp) %>% 
  filter(Sal1)
  mutate(month = yyyymmdd,substr(,5,6))
  mutate(month=as.numeric(substr(yyyymmdd,5,6))) %>% 
  mutate(season =ifelse(month==12|month==1|month==2|month==3,'winter',ifelse(month==8|month==9|month==10,'summer',''))) # adds seasons to data

```


